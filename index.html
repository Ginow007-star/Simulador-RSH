function coef(edad,cond){
  if(isNaN(edad)) return 0;
  if(edad<=5) return cond==='ninguna'?0.4:0.8;
  if(edad<=14) return cond==='ninguna'?0.3:cond==='leve'?0.34:cond==='moderada'?0.52:0.64;
  if(edad<=17) return cond==='ninguna'?0.09:cond==='leve'?0.34:cond==='moderada'?0.52:0.64;
  if(edad<=59) return cond==='ninguna'?0:cond==='leve'?0.34:cond==='moderada'?0.52:0.64;
  if(edad<=74) return cond==='ninguna'?0.61:cond==='leve'?0.68:cond==='moderada'?0.82:1.01;
  return cond==='ninguna'?0.75:cond==='leve'?0.77:cond==='moderada'?0.82:1.01;
}

function calcular(){
  let edades=[],conds=[];
  let ingresoTotal = parseFloat(ingresoJefe.value)||0;

  if(!isNaN(parseInt(edadJefe.value))){
    edades.push(parseInt(edadJefe.value));
    conds.push(condicionJefe.value);
  }

  document.querySelectorAll('.member').forEach(m=>{
    const e=parseInt(m.querySelector('.edad').value);
    if(!isNaN(e)){
      edades.push(e);
      conds.push(m.querySelector('.condicion').value);
    }
    ingresoTotal += parseFloat(m.querySelector('.ingreso').value)||0;
  });

  const N = edades.length||1;
  let sumY=0;
  edades.forEach((e,i)=>sumY+=coef(e,conds[i]));
  const IN = Math.pow(N,0.7)+sumY;

  let ingresoEq = ingresoTotal / IN;

  let alertas=[];
  let reordenado=false;

  if(parseFloat(bienes.value)>0){
    ingresoEq*=1+parseFloat(bienes.value);
    alertas.push("Bienes raíces adicionales");
    reordenado=true;
  }

  if(sistemaSalud.value==='isapre'&&(parseFloat(valorPlan.value)||0)>=4){
    ingresoEq*=1.15;
    alertas.push("Plan de salud Isapre de alto costo");
    reordenado=true;
  }

  if(tieneVehiculo.value==='si'&&(parseFloat(valorVehiculo.value)||0)>=10000000){
    ingresoEq*=1.15;
    alertas.push("Vehículo de alto valor comercial");
    reordenado=true;
  }

  if(educacion.value==='si'&&(parseFloat(valorColegio.value)||0)>=100000){
    ingresoEq*=1.15;
    alertas.push("Educación con copago relevante");
    reordenado=true;
  }

  let tramo='',porcentaje='',clase='';
  if(ingresoEq<250000){tramo='0–40%';porcentaje='40%';clase='green';}
  else if(ingresoEq<400000){tramo='41–60%';porcentaje='50%';clase='yellow';}
  else if(ingresoEq<600000){tramo='61–80%';porcentaje='70%';clase='orange';}
  else{tramo='81–100%';porcentaje='90%';clase='red';}

  resultado.innerHTML=`
  <div class="result ${clase}">
    <strong>Índice de Necesidades (IN):</strong> ${IN.toFixed(2)}<br>
    <strong>Ingreso equivalente corregido:</strong> $${ingresoEq.toFixed(0)}<br>
    <strong>Tramo CSE estimado:</strong> ${tramo} (percentil de referencia: ${porcentaje})
  </div>`;

  reordenamiento.innerHTML = reordenado ? `
  ⚠️ <strong>Evaluación de medios aplicada</strong>
  <ul>${alertas.map(a=>`<li>${a}</li>`).join("")}</ul>
  Estas condiciones no generan automáticamente un cambio de tramo,
  pero pueden dar lugar a reordenamientos administrativos en el RSH.
  ` : '';

  analisis.innerHTML = `
  <strong>Análisis socioeconómico detallado</strong><br><br>
  El hogar está compuesto por ${N} integrante(s). El Índice de Necesidades se calculó
  considerando economías de escala (N<sup>0,7</sup> = ${Math.pow(N,0.7).toFixed(2)})
  y coeficientes individuales (${sumY.toFixed(2)}), resultando en un IN de ${IN.toFixed(2)}.<br><br>
  El ingreso total líquido declarado asciende a $${ingresoTotal.toFixed(0)}.
  Tras el ajuste por IN y evaluación de medios, el hogar se ubica
  de manera referencial en el tramo ${tramo} de la Calificación Socioeconómica.
  `;
}

function exportarPDF(){
  const w=window.open('','_blank');
  w.document.write(`<h2>Resultado Simulador CSE – RSH</h2>${resultado.innerHTML}${reordenamiento.innerHTML}${analisis.innerHTML}`);
  w.print();
}

btnAdd.addEventListener('click',crearIntegrante);
btnCalc.addEventListener('click',calcular);
btnPDF.addEventListener('click',exportarPDF);

document.getElementById('members').addEventListener('click',e=>{
  if(e.target.dataset.remove){
    const m=document.querySelector(\`.member[data-id="\${e.target.dataset.remove}"]\`);
    if(m)m.remove();
  }
});

crearIntegrante();
